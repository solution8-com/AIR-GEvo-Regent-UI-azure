name: Docker Image Publish - Registry:ACR@Global:FEDERATED

on:
  push:
    branches:
    - main
    - copilot/add-n8n-webhook-chat-backend
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write           # required for OIDC
  contents: read
  
env:
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER_GLOBAL }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure login with federated identity
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_FEDERATED }}        # user-assigned managed identity client ID
          tenant-id: ${{ secrets.AZURE_TENANT_ID_FEDERATED }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_FEDERATED }}
          # uses OIDC token automatically (no client secret)

      - name: Login Docker to ACR (OIDC-backed)
        run: |
          az acr login --name acrregenttest

      - name: Build image
        run: |
          docker build -f WebApp.Dockerfile -t $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }} .
      
      - name: Tag as latest
        run: |
          docker tag $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }} $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
      
      - name: Push images
        run: |
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:${{ github.sha }}
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest
